<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>西中島南方駅 徒歩圏マップ（リンク付き）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .control-panel {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: white; padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .control-panel h3 { margin: 0 0 6px; font-size: 16px; }
    .legend { font-size: 12px; line-height: 1.6; }
    .legend label { display: flex; align-items: center; gap: 6px; margin: 2px 0; cursor: pointer; }
    .legend input { transform: translateY(1px); }
    .popup a { text-decoration: none; }
    .footer-note {
      position: absolute; bottom: 6px; right: 10px; z-index: 900;
      background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 10px; font-size: 12px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <h3>ジャンル表示</h3>
    <div class="legend" id="legend"></div>
  </div>
  <div class="footer-note">※住所をオンラインでジオコーディングして表示します（Nominatim / OSM）。</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Data: name, category, address, url
    const places = [
      // 焼肉
      {name: "板前焼肉 一笑 西中島", category: "焼肉", address: "大阪府大阪市淀川区西中島5-9-6 新大阪サンアールビル本館1F", url: "https://k726002.gorp.jp/"},
      {name: "肉處 きっしゃん 西中島総本店", category: "焼肉", address: "大阪府大阪市淀川区西中島3-13-14 タカミビル1階", url: "https://mjybeef.com/sohonten/"},

      // 焼き鳥・居酒屋
      {name: "七輪焼鳥 一鳥 西中島店", category: "焼き鳥・居酒屋", address: "大阪府大阪市淀川区西中島3-14-9 1F", url: "https://nishinakajima.yakitori-icchou.com/"},
      {name: "備長炭 焼き鳥 えんのば 西中島店", category: "焼き鳥・居酒屋", address: "大阪府大阪市淀川区西中島3-17-10 新大阪第2南ビル 2F", url: "https://s.tabelog.com/osaka/A2701/A270301/27137141/"},
      {name: "下町居酒屋 ありがたやぁ〜", category: "焼き鳥・居酒屋", address: "大阪府大阪市淀川区西中島3-19-19 寿ビル 1階", url: "https://arigatayaa.foodre.jp/"},
      
      // 海鮮・立ち飲み
      {name: "酒スタンド 魚蔵 西中島3丁目店", category: "海鮮・立ち飲み", address: "大阪府大阪市淀川区西中島3-17-5 1F", url: "https://kc8d206.gorp.jp/"},
      {name: "立喰酒場 金獅子 西中島南方店", category: "海鮮・立ち飲み", address: "大阪府大阪市淀川区西中島4-2-8 Y.S新大阪ビル 中1階", url: "https://s.tabelog.com/osaka/A2701/A270301/27067834/"},

      // お好み焼き・鉄板
      {name: "やきやき鉄板 ぼんくら家 西中島店", category: "お好み焼き・鉄板", address: "大阪府大阪市淀川区西中島3-19-7 第一ユヤマビル 1F", url: "https://c770939.gorp.jp/"},
      {name: "ねぎ焼・お好み焼き 和（かず）", category: "お好み焼き・鉄板", address: "大阪府大阪市淀川区西中島3-16-6 1F", url: "https://tabelog.com/osaka/A2701/A270301/27018403/"},

      // 寿司
      {name: "鮨・酒・肴 杉玉 西中島南方", category: "寿司", address: "大阪府大阪市淀川区西中島3-16-6 三好第2ビル1F", url: "https://www.sugidama-sushiizakaya.jp/shop/505/"},
      {name: "やぐら寿し", category: "寿司", address: "大阪府大阪市淀川区西中島1-12-18", url: "https://www.yagurasushi.com/"},

      // 〆ラーメン
      {name: "人類みな麺類（西中島）", category: "ラーメン", address: "大阪府大阪市淀川区西中島1-12-15", url: "https://www.jinrui-minamenrui.com/"},
      {name: "麺匠 はなみち 新大阪店", category: "ラーメン", address: "大阪府大阪市淀川区西中島4-4-25 フルーレ新大阪 1F", url: "https://menshohanamichi.jp/free/shinosaka"},

      // 2軒目バー
      {name: "Public Bar STINGER", category: "バー", address: "大阪府大阪市淀川区西中島3-17-3 5F", url: "https://stinger2017.jp/"}
    ];

    // Category colors (marker emoji for quick visual grouping)
    const categoryMarker = {
      "焼肉": "🍖",
      "焼き鳥・居酒屋": "🍢",
      "海鮮・立ち飲み": "🐟",
      "お好み焼き・鉄板": "🥞",
      "寿司": "🍣",
      "ラーメン": "🍜",
      "バー": "🍸"
    };

    // Initialize map centered around Nishinakajima-Minamigata
    const map = L.map('map');
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
    }).addTo(map);

    // Layer groups by category
    const layersByCategory = {};
    const bounds = L.latLngBounds();

    // Utility: build a simple emoji DivIcon
    function makeEmojiIcon(emoji) {
      return L.divIcon({
        html: `<div style="font-size:20px; line-height:20px">${emoji}</div>`,
        iconSize: [24, 24],
        className: "emoji-marker"
      });
    }

    // Geocode function using Nominatim
    async function geocode(addr) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'ja' } });
      if (!res.ok) throw new Error('geocode failed');
      const data = await res.json();
      if (data && data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      }
      return null;
    }

    // Plot all places
    (async () => {
      // Prepare legend checkboxes
      const uniqCategories = [...new Set(places.map(p => p.category))];
      const legendEl = document.getElementById('legend');
      uniqCategories.forEach(cat => {
        const id = `chk-${cat}`;
        const div = document.createElement('div');
        div.innerHTML = `<label><input type="checkbox" id="${id}" checked> ${categoryMarker[cat] || "📍"} ${cat}</label>`;
        legendEl.appendChild(div);
      });

      // Create layers
      uniqCategories.forEach(cat => {
        layersByCategory[cat] = L.layerGroup().addTo(map);
      });

      for (const p of places) {
        try {
          const latlon = await geocode(p.address);
          if (!latlon) continue;
          const emoji = categoryMarker[p.category] || "📍";
          const marker = L.marker(latlon, { icon: makeEmojiIcon(emoji), title: p.name });
          const gmUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address)}`;
          marker.bindPopup(`<div class="popup"><strong>${p.name}</strong><br>
            <span>${p.address}</span><br>
            <a href="${p.url}" target="_blank" rel="noopener">公式ページ</a> ｜
            <a href="${gmUrl}" target="_blank" rel="noopener">Googleマップ</a>
          </div>`);
          marker.addTo(layersByCategory[p.category]);
          bounds.extend(latlon);
        } catch (e) {
          console.warn('Failed to locate', p.name, e);
        }
      }

      if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.15));
      } else {
        map.setView([34.733, 135.501], 15); // fallback around 西中島南方
      }

      // Wire up legend checkboxes
      uniqCategories.forEach(cat => {
        const el = document.getElementById(`chk-${cat}`);
        el.addEventListener('change', (e) => {
          if (e.target.checked) {
            layersByCategory[cat].addTo(map);
          } else {
            map.removeLayer(layersByCategory[cat]);
          }
        });
      });
    })();
  </script>
</body>
</html>
